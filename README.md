# Race simulation
This repository is dedicated to the exploration of a race simulation for the purpose of a management game in the style of F1 manager or Motorsport Manager.

## Track simulation

Taking track information gathered from GPS data in a project of TUMFTM to calculate and simulate forces acting on the vehicle.
Source of the data: https://github.com/TUMFTM/racetrack-database

We use the width of the track given in the data points in the racetrack database to recreate the left and right track limit lines.
![budapest_example](fig/budapest.svg)

Then we use the formula for the curvature of a curve at a particular point based on the radius of the circle that best approximates the curve at that point. The formula is used to calculate the curvature of the track at each point. The curvature could be then used to calculate the lateral forces acting on the vehicle.

To determine the speed of the vehicle we will also experiment with using the curvature. By offsetting the curvature by a certain amount we can get a rough estimate of where the vehicle should be braking and accelerating.
![curvature](fig/budapest_curvature.svg)
**Figure 1:** Example of the braking and accelerating points based on the curvature of the track offset by 10.

## Car simulation
To calculate the speed at which the cars travel around the track somewhat realistically. We need to create a simplified physics engine for the car. The different characteristics that the player can develop should affect different part of the car performance to reward him accordingly.

Should we separate the car performance for the simulation in parts we could have :

- Engine Power
- Weight
- Downforce
- Tire Grip
- Braking

### Characteristics

#### Power Unit

##### Engine Power

The engine, the main driving force of the car, will affect the acceleration and the top speed. Although both of those characteristic will rely on other factors such as the weight and the drag coefficient.

Let’s say a first that the engine power is modelled as a single unit $P$, number of watts outputted by the engine.

##### RPM

The engine's RPM is related to the car's speed, the current gear ratio, and the final drive ratio of the car's differential. The relationship can be expressed as:

$$
RPM=\frac{v\times R_g[i]\times R_d\times 60}{2\pi \times r_{wheel}}
$$

Where $v$ is the speed, $R_g$ is the ratio of the gear selected, $R_d$ is the ratio of the differential and $r_{wheel}$ is the radius of the wheels.

##### Torque Output

Engines have a specific torque curve, which is a graph of the engine's torque output at different RPMs. A quadratic function can represent this:

$$
T_{engine}(RPM)=a\times RPM^2+b\times RPM+c
$$

Where $a$, $b$ and $c$ are constant that define the torque curve. We can adjust them depending on the engine characteristics.

##### Gear Ratio

The car has $N$ gears in it’s transmission, each multiplying the torque output by a specific amount. For exemple of a transmission with 6 gears we can have : 

$$
R_g=[3.5, 2.8, 2.1, 1.7, 1.3, 1]
$$

##### Wheel Torque

The torque transferred to the wheels is the engine torque multiplied by the selected gear ratio :

$$
T_{wheel}=T_{engine}\times R_g[i]
$$

##### Wheel Force

Then, the force transferred from the wheel to the ground depends on the radius of the wheel : 

$$
F_{wheel}=\frac{T_{wheel}}{r_{wheel}}
$$

#### Weight

More complex cars and stronger power units are usually heavier. The increased weight will make the car more “laggy” and decrease the rate at which it can both accelerate, decelerate and turn.

This will be modelled obviously as $w$, the weight of the car in kg.

#### Downforce

The force generated by the aerodynamic elements of the car. It is noted $D$ and is measured in Newton. The force generated by the aerodynamic elements increases with speed, we define $D$ as a polynomial function to represent cars that have better downforce at different ranges.

$$
D(v)=a\times v^2 + b\times v + c
$$

Where $a$, $b$ and $c$ are constants that define the aerodynamic profile of the car and $v$ is the speed.

- A car optimised for high-speed corners might have a higher *a* coefficient. While a car optimised for medium-speed corners might have a higher *b* coefficient.

#### Tire Grip

The tires have a certain amount of grip it can provide to the car before it starts slipping. This limits the car ability to accelerate, decelerate and turn.

It is noted $G$ and varies between 0 (no grip) and 1 (maximum grip). It can varies depending on factors such as tire compound, tire life, tire temperature, track surface etc.

##### Tire Compound

| Soft | Medium | Hard | Intermediate | Wet |
| --- | --- | --- | --- | --- |
| 1 | 0.9 | 0.75 | 0.6 | 0.5 |

##### Tire Temperature

Each compound has an optimal temperature window, outside of this range the grip decreases linearly (TODO define).

##### Tire Wear

As the tires wear, the grip decreases. We can imagine that the grip decreases linearly up to 40% where it starts to decrease exponentially. Representing the cliff in tire performance.

##### Others

TODO weather, track surface, …

#### Drag Force

Drag is the force opposing the motion of the car moving through the air. It affects the acceleration and the top speed. Noted $F_d$ it can be modelled by the equation :

$$
F_d=\frac{\rho \times A \times C_d \times v^2}{2}
$$

Where $\rho$ is the air density, $A$ is the size of the car geometry., $C_d$ is the drag coefficient and $v$ is the speed.

### Performance

#### Acceleration

The acceleration, noted $a$, is the rate at which the car’s speed increases. It's directly proportional to the forces applied to the car and inversely proportional to the car's weight.

$$
a=\frac{F}{w}
$$

We calculate $F$ the longitudinal forces on the car as $\frac{P}{v}-F_{d}$.

#### Braking Performance

The force needed to stop a car is affected by it’s weight and the grip. Heavier cars require more force to stop, and cars with better grip can brake more effectively. We can calculate as :

$$
d=g\times G
$$

Where $g$ is the grip, $G$ is the gravitational acceleration (9.81)